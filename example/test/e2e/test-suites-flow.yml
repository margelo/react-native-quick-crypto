appId: com.margelo.quickcrypto.example
jsEngine: graaljs
---
# Launch the app
- launchApp

# Wait for app to load completely and UI to be ready
- extendedWaitUntil:
    visible: 'Run'
    timeout: 30000

# Verify other key UI elements are present
- assertVisible: 'Check All'
- assertVisible: 'Clear All'

# Select all tests by tapping "Check All"
- tapOn: 'Check All'

# Wait for selection to complete
- waitForAnimationToEnd:
    timeout: 2000

# Take screenshot after selecting all (will be overwritten)
- takeScreenshot: ${PLATFORM}-test-result

# Run all tests by tapping "Run"
- tapOn: 'Run'

# Wait for tests to start
- waitForAnimationToEnd:
    timeout: 5000

# Take screenshot of tests running (will be overwritten)
- takeScreenshot: ${PLATFORM}-test-result

# Wait for all tests to complete by waiting for completion stats to appear
# The completion-stats element shows "✅ X | ❌ Y | ⏱️ Zms" when all tests finish
- extendedWaitUntil:
    visible:
      id: 'completion-stats'
    timeout: 60000

# Wait a moment for UI to settle before taking final screenshot
- waitForAnimationToEnd:
    timeout: 2000

# Take final screenshot (this is the one we want to keep)
- takeScreenshot: ${PLATFORM}-test-result

# Copy total fail count for later assertion
- copyTextFrom:
    id: 'total-fail-count'

# Check each suite for failures and gather details if any found
- evalScript: ${output.suiteIndex = 0}
- evalScript: ${output.totalFailures = maestro.copiedText}
- repeat:
    while:
      visible:
        id: 'test-suite-${output.suiteIndex}-name'
    commands:
      - copyTextFrom:
          id: 'test-suite-${output.suiteIndex}-fail-count'
      - runFlow:
          when:
            true: ${maestro.copiedText !== ''}
          file: gather-failed-tests.yml
          env:
            SUITE_INDEX: ${output.suiteIndex}
            SUITE_NAME: suite-${output.suiteIndex}
      - evalScript: ${output.suiteIndex = output.suiteIndex + 1}

# Assert no failures - check that total fail count is "0"
- assertTrue:
    condition: ${output.totalFailures === '0'}
    label: 'All test suites passed (0 failures)'

# Additional verification: ensure we can still interact with the UI
- assertVisible: 'Run'
- assertVisible: 'Check All'
- assertVisible: 'Clear All'
