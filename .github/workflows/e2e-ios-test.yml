name: End-to-End Tests for iOS

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'push' && github.sha || github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '.github/workflows/e2e-ios-test.yml'
      - 'example/**'
      - 'cpp/**'
      - 'nitrogen/**'
      - 'src/**'
  push:
    branches: [main]
    paths:
      - 'example/**'
      - 'cpp/**'
      - 'nitrogen/**'
      - 'src/**'

jobs:
  e2e-tests-ios:
    runs-on: macos-15
    env:
      OUTPUT_DIR: ~/output
      USE_CCACHE: '1'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s "/Applications/Xcode_16.4.app/Contents/Developer"
          xcodebuild -version

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 1.5G
          key: ${{ runner.os }}-ccache-ios-e2e
          create-symlink: true

      - name: Configure ccache
        run: |
          echo "CCACHE_SLOPPINESS=clang_index_store,file_stat_matches,include_file_ctime,include_file_mtime,ivfsoverlay,pch_defines,modules,system_headers,time_macros" >> $GITHUB_ENV
          echo "CCACHE_FILECLONE=true" >> $GITHUB_ENV
          echo "CCACHE_DEPEND=true" >> $GITHUB_ENV
          echo "CCACHE_INODECACHE=true" >> $GITHUB_ENV

      - name: Install Bun
        uses: ./.github/actions/setup-bun

      - name: Create Directories
        run: |
          mkdir -p $HOME/output
          mkdir -p $HOME/.maestro/tests/

      - name: Install Dependencies
        run: bun install

      - name: Cache CocoaPods
        uses: actions/cache@v4
        id: pods-cache
        with:
          path: example/ios/Pods
          key: ${{ runner.os }}-pods-v3-${{ hashFiles('example/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-v3-

      - name: Install CocoaPods
        if: steps.pods-cache.outputs.cache-hit != 'true'
        working-directory: ./example
        run: bun pods

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: example/ios/build
          key: ${{ runner.os }}-dd-v3-${{ hashFiles('example/ios/Podfile.lock', 'package.json', 'bun.lock') }}-xcode16.4
          restore-keys: |
            ${{ runner.os }}-dd-v3-

      - name: Install Maestro CLI
        run: |
          export MAESTRO_VERSION=2.0.10
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Make scripts executable
        run: chmod +x test/e2e/*.sh
        working-directory: ./example/

      - name: Boot iOS Simulator
        run: |
          xcrun simctl boot "iPhone 16 Pro" || true
          xcrun simctl bootstatus "iPhone 16 Pro" -b

      - name: Run E2E Tests
        id: test_ios
        run: ./test/e2e/run-ios.sh
        working-directory: ./example/
        env:
          IOS_SIMULATOR_DEVICE: 'iPhone 16 Pro'

      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Post Maestro Screenshot to PR
        if: always()
        uses: ./.github/actions/post-maestro-screenshot
        with:
          platform: ios
          github-token: ${{ secrets.GITHUB_TOKEN }}
          test-outcome: ${{ steps.test_ios.outcome }}
          imgbb-api-key: ${{ secrets.IMGBB_API_KEY }}

      - name: Upload Test Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-ios-test-output
          path: |
            ${{ env.OUTPUT_DIR }}/*.log
            ${{ env.OUTPUT_DIR }}/screenshots/*.png
          retention-days: 5

      - name: Exit with Test Result
        if: always()
        run: |
          if [ "${{ steps.test_ios.outcome }}" != "success" ]; then
            exit 1
          fi
