<rules category="ci-caching">
  <metadata>
    <trigger>when working on GitHub Actions workflows or CI caching</trigger>
  </metadata>

  <rule severity="HIGH" enforcement="STRICT">
    <name>Reference Implementations</name>
    <description>Use these repos as reference for CI patterns</description>
    <references>
      <reference>
        <path>$REPOS/nitro</path>
        <description>Super-fast iOS builds with proper caching</description>
        <files>.github/workflows/build-ios.yml</files>
      </reference>
      <reference>
        <path>$REPOS/spicy</path>
        <description>Working Android E2E with Maestro</description>
        <files>.github/workflows/e2e.yml, tests/e2e/scripts/</files>
      </reference>
    </references>
  </rule>

  <rule severity="CRITICAL" enforcement="BLOCKING">
    <name>iOS Pods and DerivedData Cache Consistency</name>
    <description>Pods project files contain hardcoded paths to DerivedData</description>
    <problem>
      Pods cache contains xcodeproj files that reference paths like ios/build/generated/ios/*.cpp.
      If Pods restores but DerivedData doesn't, build fails with "Build input file cannot be found".
    </problem>
    <solutions>
      <solution>Use exact-match only for Pods cache (no restore-keys fallback)</solution>
      <solution>Ensure DerivedData cache key is superset of Pods cache key</solution>
      <solution>Restore DerivedData AFTER pod install runs (like Nitro does)</solution>
    </solutions>
    <antipattern>
      Using restore-keys for Pods cache can restore stale Pods that reference non-existent codegen files.
    </antipattern>
  </rule>

  <rule severity="CRITICAL" enforcement="BLOCKING">
    <name>Cache Key Design — Immutable Keys</name>
    <description>GitHub Actions caches are IMMUTABLE — cache/save fails if the key already exists</description>
    <problem>
      actions/cache/save cannot overwrite an existing cache entry. Using static keys
      (e.g. runner.os-gradle) means the first save succeeds, but every subsequent save
      fails with "Unable to reserve cache with key X, another job may be creating this cache."
      Caches become permanently stale.
    </problem>
    <guidelines>
      <guideline>Save key MUST be unique per run: prefix-${{ github.run_id }}</guideline>
      <guideline>Restore uses exact key + restore-keys prefix fallback to get the latest</guideline>
      <guideline>Don't use version suffixes (v2, v3) — purge with gh cache delete --all</guideline>
      <guideline>Old cache entries are evicted automatically by GitHub's LRU policy</guideline>
    </guidelines>
    <example>
      Restore: key=runner.os-gradle-${{ github.run_id }}, restore-keys=runner.os-gradle-
      Save:    key=runner.os-gradle-${{ github.run_id }}
    </example>
  </rule>

  <rule severity="HIGH" enforcement="STRICT">
    <name>Android Maestro App Launch</name>
    <description>Don't launch app before Maestro</description>
    <problem>
      If you launch the app via adb before Maestro runs, Maestro's launchApp command
      will restart it, potentially breaking Metro connection.
    </problem>
    <solution>
      Let Maestro handle app launch. Only install the APK before Maestro runs.
    </solution>
  </rule>

  <rule severity="MEDIUM" enforcement="GUIDANCE">
    <name>Debugging CI Failures</name>
    <description>Commands for investigating CI issues</description>
    <commands>
      <command>gh run list --branch BRANCH --limit 5</command>
      <command>gh run view RUN_ID --log-failed</command>
      <command>gh run download RUN_ID --name ARTIFACT -D /tmp/output</command>
      <command>gh cache list</command>
      <command>gh cache delete --all</command>
    </commands>
  </rule>

  <rule severity="MEDIUM" enforcement="GUIDANCE">
    <name>Build Speed Targets</name>
    <description>Expected build times with proper caching</description>
    <targets>
      <target>iOS incremental build: under 2 minutes</target>
      <target>Android incremental build: under 3 minutes</target>
      <target>Full iOS build (no cache): ~15-20 minutes</target>
      <target>Full Android build (no cache): ~10 minutes</target>
    </targets>
    <notes>
      ccache handles C++ compilation caching.
      DerivedData/Gradle caches handle build artifacts.
    </notes>
  </rule>
</rules>
